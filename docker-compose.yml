services:
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: postgres_db
  #   restart: always
  #   env_file:
  #     - .env.prod
  #   environment:
  #     POSTGRES_USER: $POSTGRES_USER
  #     POSTGRES_DB: $POSTGRES_DB
  #     POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  #     PGDATA: "/var/lib/postgresql/data/pgdata"
  #   ports:
  #     - "5432:5432"
  #   command: >
  #     postgres -c max_connections=1000
  #              -c shared_buffers=256MB
  #              -c effective_cache_size=768MB
  #              -c maintenance_work_mem=64MB
  #              -c checkpoint_completion_target=0.7
  #              -c wal_buffers=16MB
  #              -c default_statistics_target=100
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data/pgdata
  #   healthcheck:
  #     test: [ "CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB" ]
  #     interval: 15s
  #     timeout: 30s
  #     retries: 5
  #     start_period: 30s

  kafka:
    image: apache/kafka:3.9.1
    env_file:
      - .env.prod
    ports:
      - "9092:9092"
    environment:
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'
      KAFKA_LISTENERS: 'SASL_PLAINTEXT://:9092,CONTROLLER://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'SASL_PLAINTEXT://localhost:9092'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'SASL_PLAINTEXT'
      CLUSTER_ID: $KAFKA_CLUSTER_ID

      KAFKA_SASL_ENABLED_MECHANISMS: 'SCRAM-SHA-256'
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: 'SCRAM-SHA-256'
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"
      KAFKA_SUPER_USERS: "User:admin"

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_NUM_PARTITIONS: 3

      KAFKA_ADMIN_USER: $KAFKA_ADMIN_USER
      KAFKA_ADMIN_PASSWORD: $KAFKA_ADMIN_PASSWORD
      KAFKA_APP_USER: $KAFKA_APP_USER
      KAFKA_APP_PASSWORD: $KAFKA_APP_PASSWORD

    volumes:
      - ./kafka/kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf
      - ./kafka/init-users.sh:/init-users.sh
      - kafka_data:/var/lib/kafka/data
      - ./kafka/entrypoint.sh:/entrypoint.sh

    command: [ "bash", "/entrypoint.sh" ]

    healthcheck:
      test: [ "CMD-SHELL", "cub kafka-ready -b localhost:9092 -t 5 || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 10

  core-api:
    container_name: core-api-service
    image: core-api-image
    restart: always
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      PYTHONUNBUFFERED: 1
    env_file:
      - .env
    depends_on:
      - postgres
      - kafka
    ports:
      - "8000:8000"

volumes:
  postgres_data:
  kafka_data:
